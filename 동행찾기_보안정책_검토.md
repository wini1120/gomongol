# 동행찾기 보안 정책 변경 검토

## 요청 사항 요약
- **현재**: 게시글 작성 시 닉네임 + 비밀번호 4자리 → 수정 시 비밀번호만 입력해 확인
- **변경**: 게시글 작성 시 **ID, PW** 설정 + **이름, 닉네임** 필수 수집 → 수정 시 ID+PW로 확인
- **추가**: ID/PW 입력 시 Supabase에 **travel_user** 테이블에 유저 정보 생성  
  - 컬럼: 유저넘버, 유저ID, 유저PW, 유저 닉네임, 유저이름

---

## 1. 제가 코드로 한 번에 할 수 있는 것 ✅

| 항목 | 내용 |
|------|------|
| **ItineraryBuilder (게시글 작성)** | 작성 폼에 **ID, PW, 이름, 닉네임** 필드 추가(필수). 기존 "비밀번호 4자리"를 ID+PW 방식으로 변경. |
| **travel_user 연동** | 게시글 저장 시 1) `travel_user`에 insert → 2) 반환된 `유저넘버`로 `posts`에 `travel_user_id` 넣어서 insert 하는 로직 작성. |
| **PostDetail (수정/삭제)** | 수정·삭제 시 "비밀번호 4자리" 대신 **ID + PW** 입력받고, `travel_user`에서 ID/PW 일치 여부 확인 후, 해당 유저가 이 글의 작성자(`post.travel_user_id`)인지 검사하는 로직으로 변경. |
| **CommunityBoard** | 게시글 목록은 계속 `post.nickname`으로 표시 가능(닉네임을 `posts`에 그대로 저장하면 됨). 별도 수정 최소화. |

즉, **프론트/앱 로직과 Supabase 클라이언트 호출까지는 한 번에 구현 가능**합니다.

---

## 2. 제가 할 수 없고, 꼭 사용자님이 해야 하는 것 ❌

Supabase 대시보드/DB는 제가 접속할 수 없습니다. 아래 작업은 **Supabase Dashboard → SQL Editor**에서 직접 실행해 주셔야 합니다.

### 2-1. `travel_user` 테이블 생성

```sql
-- travel_user 테이블 생성
CREATE TABLE IF NOT EXISTS travel_user (
  user_no    BIGSERIAL PRIMARY KEY,   -- 유저넘버 (자동 증가)
  user_id    TEXT NOT NULL UNIQUE,    -- 유저ID (로그인용, 중복 불가)
  user_pw    TEXT NOT NULL,           -- 유저PW
  nickname   TEXT NOT NULL,            -- 유저 닉네임
  user_name  TEXT NOT NULL,           -- 유저이름
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스 (ID로 로그인 검증 시 사용)
CREATE INDEX IF NOT EXISTS idx_travel_user_user_id ON travel_user(user_id);
```

### 2-1-1. `travel_user` RLS 정책 (anon이 insert/select 가능하게)

Supabase SQL Editor에서 **테이블 생성 후** 아래를 실행하세요.

```sql
-- RLS 활성화
ALTER TABLE travel_user ENABLE ROW LEVEL SECURITY;

-- anon: 새 유저 등록(insert) 허용
CREATE POLICY "anon_insert_travel_user"
  ON travel_user FOR INSERT
  TO anon
  WITH CHECK (true);

-- anon: ID/PW 확인용 조회(select) 허용 (로그인 검증 시 필요)
CREATE POLICY "anon_select_travel_user"
  ON travel_user FOR SELECT
  TO anon
  USING (true);
```

- **INSERT**: 게시글 작성 시 `travel_user`에 새 행을 넣을 수 있음.
- **SELECT**: 수정/삭제 시 입력한 ID+PW로 `travel_user`에서 일치하는 행을 조회할 수 있음.
- **UPDATE/DELETE**: anon은 허용하지 않음 → 다른 사람 계정 변경/삭제 불가.

### 2-2. `posts` 테이블에 컬럼 추가

게시글과 유저를 연결하려면 `posts`에 **작성자 유저**를 가리키는 컬럼이 필요합니다.

```sql
-- posts 테이블에 작성자 유저 FK 추가
ALTER TABLE posts
  ADD COLUMN IF NOT EXISTS travel_user_id BIGINT REFERENCES travel_user(user_no);
```

- 기존 컬럼 **`nickname`**, **`password`**  
  - **nickname**: 목록/상세에서 "by 닉네임" 표시용으로 그대로 둡니다. (작성 시 `travel_user.nickname`을 복사해 저장)  
  - **password**: 더 이상 사용하지 않습니다. `NOT NULL`이면 아래처럼 nullable로 바꿔 주세요.  
    ```sql
    ALTER TABLE posts ALTER COLUMN password DROP NOT NULL;
    ```

정리하면, **테이블 생성 + posts 컬럼 추가 + RLS** 까지는 사용자님이 Supabase에서 진행해 주셔야 합니다.

---

## 3. 부족한 정보 / 선택 필요 사항

### 3-1. 비밀번호 저장 방식
- **적용함**: 프론트엔드에서 **bcryptjs**로 해시 후 `travel_user.user_pw`에 저장. 수정/삭제 시 `comparePassword`로 검증.

### 3-2. ID 형식
- **적용함**: 영문(대소문자) + 숫자만 허용, **4~20자**. `authUtils.isValidUserId()`로 검증, 입력 시 비허용 문자는 자동 제거.

### 3-3. 기존 게시글 처리
- **적용함**: 기존 게시글 전부 삭제한 상태로, 모든 글은 `travel_user_id` 기준으로만 수정/삭제. 예전 비밀번호 분기 없음.

---

## 4. 진행 순서 제안

1. **사용자님**: Supabase에서  
   - `travel_user` 테이블 생성  
   - `posts`에 `travel_user_id` 추가  
   - (필요 시) RLS 정책 추가  
2. **사용자님**: 비밀번호 평문/해시, ID 규칙, 기존 게시글 처리 방식 결정 후 알려주시기  
3. **제가**:  
   - ItineraryBuilder: ID/PW/이름/닉네임 필수 입력 + travel_user 생성 + posts에 travel_user_id 저장  
   - PostDetail: 수정/삭제 시 ID+PW 입력 → travel_user 검증 → travel_user_id 일치 시 수정/삭제  
   - CommunityBoard: 필요 시 nickname 표시만 유지  

이 순서로 하시면, 말씀하신 보안 정책 변경을 한 번에 적용할 수 있습니다.

---

## 5. 한 줄 요약

- **코드로 한 번에 가능한 것**: 게시글 작성 폼(ID/PW/이름/닉네임), travel_user insert 연동, 수정/삭제 시 ID+PW 검증 로직, 목록 노출 방식 유지.
- **꼭 사용자님이 할 일**: Supabase에 `travel_user` 테이블 생성, `posts`에 `travel_user_id` 추가, RLS 설정.
- **결정이 필요한 것**: 비밀번호 평문 vs 해시, ID 규칙, 기존 게시글 수정 방식.

위만 채워 주시면, 나머지 구현은 한 번에 진행할 수 있습니다.
